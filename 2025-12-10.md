# 2025-12-10 å­¦ä¹ ç¬”è®° - Linuxå¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€

## ğŸ“š ä»Šæ—¥å­¦ä¹ å†…å®¹

### 1. çº¿ç¨‹åˆ›å»ºä¸åŸºæœ¬æ“ä½œ

#### 1.1 çº¿ç¨‹åˆ›å»ºåŸºç¡€
- **çº¿ç¨‹æ¦‚å¿µ**ï¼šè½»é‡çº§è¿›ç¨‹ï¼Œå…±äº«è¿›ç¨‹èµ„æºä½†æ‹¥æœ‰ç‹¬ç«‹æ‰§è¡Œæµ
- **åˆ›å»ºå‡½æ•°**ï¼š`pthread_create()`
- **çº¿ç¨‹ID**ï¼š`pthread_t`ç±»å‹ï¼Œä½¿ç”¨`pthread_self()`è·å–å½“å‰çº¿ç¨‹ID

**åŸºç¡€çº¿ç¨‹åˆ›å»ºç¤ºä¾‹**ï¼š<mcfile name="thread_create1.c" path="/home/embedded-learning/2025-12-10/code/thread_create1.c"></mcfile>
```c
// åˆ›å»ºå•ä¸ªçº¿ç¨‹è®¡ç®—1-100ç´¯åŠ å’Œ
pthread_t tid;
int ret = pthread_create(&tid, NULL, thread_sum, NULL);
if(ret != 0){
    perror("pthread_create failed"); 
    exit(1);
}
printf("ä¸»çº¿ç¨‹PID/TID:%d/%lu,åˆ›å»ºå­çº¿ç¨‹TID:%lu\n",getpid(),(unsigned long)pthread_self(),(unsigned long)tid);
```

#### 1.2 çº¿ç¨‹è¿”å›å€¼ä¸è¿æ¥
- **çº¿ç¨‹è¿”å›å€¼**ï¼šé€šè¿‡`void*`æŒ‡é’ˆè¿”å›ï¼Œéœ€è¦ç±»å‹è½¬æ¢
- **çº¿ç¨‹è¿æ¥**ï¼š`pthread_join()`ç­‰å¾…çº¿ç¨‹ç»“æŸå¹¶è·å–è¿”å›å€¼
- **è¿”å›å€¼è½¬æ¢**ï¼šä½¿ç”¨`(long)`è¿›è¡Œå®‰å…¨ç±»å‹è½¬æ¢

**çº¿ç¨‹è¿”å›å€¼ç¤ºä¾‹**ï¼š<mcfile name="thread_join.c" path="/home/embedded-learning/2025-12-10/code/thread_join.c"></mcfile>
```c
// åˆ›å»ºå¤šä¸ªçº¿ç¨‹è®¡ç®—é˜¶ä¹˜
void *factorial(void *arg){
    int n = (int)(long)arg;
    long result = 1;
    for (int i = 1; i <= n; i++) {
        result *= i;
    }
    return (void *)result;
}

// è·å–çº¿ç¨‹è¿”å›å€¼
void *ret;
pthread_join(tid, &ret);
printf("çº¿ç¨‹è¿”å›å€¼ï¼š%ld\n", (long)ret);
```

### 2. çº¿ç¨‹åŒæ­¥æœºåˆ¶

#### 2.1 æ•°æ®ç«äº‰é—®é¢˜ (Race Condition)
- **é—®é¢˜æè¿°**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- **å…¸å‹è¡¨ç°**ï¼šé¢„æœŸç»“æœä¸å®é™…ç»“æœä¸ç¬¦

**æ•°æ®ç«äº‰ç¤ºä¾‹**ï¼š<mcfile name="race_condition.c" path="/home/embedded-learning/2025-12-10/code/race_condition.c"></mcfile>
```c
// ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ç´¯åŠ g_count 10000æ¬¡
void *add_count(void *arg) {
    for(int i = 0; i < 10000; i++){
        g_count++;  // æ•°æ®ç«äº‰ç‚¹ï¼
    }
    return NULL;
}
// é¢„æœŸç»“æœï¼š20000ï¼Œå®é™…ç»“æœè¿œå°äº20000
```

#### 2.2 äº’æ–¥é” (Mutex) è§£å†³æ–¹æ¡ˆ
- **é™æ€åˆå§‹åŒ–**ï¼š`PTHREAD_MUTEX_INITIALIZER`
- **åŠ¨æ€åˆå§‹åŒ–**ï¼š`pthread_mutex_init()`
- **é”æ“ä½œ**ï¼š`pthread_mutex_lock()` / `pthread_mutex_unlock()`

**åŠ¨æ€äº’æ–¥é”ç¤ºä¾‹**ï¼š<mcfile name="mutex_dynamic.c" path="/home/embedded-learning/2025-12-10/code/mutex_dynamic.c"></mcfile>
```c
// åŠ¨æ€åˆ†é…äº’æ–¥é‡
pthread_mutex_t *mutex = (pthread_mutex_t *)malloc(sizeof(pthread_mutex_t));
pthread_mutex_init(mutex, NULL);

// ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤ä¸´ç•ŒåŒº
pthread_mutex_lock(mutex);
g_count++;  // ä¸´ç•ŒåŒºæ“ä½œ
pthread_mutex_unlock(mutex);

// é”€æ¯äº’æ–¥é‡
pthread_mutex_destroy(mutex);
free(mutex);
```

**é™æ€äº’æ–¥é”ç¤ºä¾‹**ï¼š<mcfile name="mutex_fix.c" path="/home/embedded-learning/2025-12-10/code/mutex_fix.c"></mcfile>
```c
// é™æ€åˆå§‹åŒ–äº’æ–¥é‡
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
```

#### 2.3 è¯»å†™é” (Read-Write Lock)
- **è¯»é”**ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å–è¯»é”ï¼ˆå…±äº«ï¼‰
- **å†™é”**ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–å†™é”ï¼ˆç‹¬å ï¼‰
- **é€‚ç”¨åœºæ™¯**ï¼šè¯»å¤šå†™å°‘çš„å¹¶å‘åœºæ™¯

**è¯»å†™é”ç¤ºä¾‹**ï¼š<mcfile name="rwlock_demo.c" path="/home/embedded-learning/2025-12-10/code/rwlock_demo.c"></mcfile>
```c
// é™æ€åˆå§‹åŒ–è¯»å†™é”
pthread_rwlock_t rwlock = PTHREAD_RWLOCK_INITIALIZER;

// è¯»çº¿ç¨‹ï¼šè·å–è¯»é”
void *read_config(void *arg){
    pthread_rwlock_rdlock(&rwlock);
    printf("è¯»çº¿ç¨‹%d:è¯»å–é…ç½®=%d\n",tid, g_config);
    pthread_rwlock_unlock(&rwlock);
    return NULL;
}

// å†™çº¿ç¨‹ï¼šè·å–å†™é”
void *write_config(void *arg){
    pthread_rwlock_wrlock(&rwlock);
    g_config +=10;
    printf("=====å†™çº¿ç¨‹%d:ä¿®æ”¹é…ç½®ä¸º%d ====\n",tid, g_config);
    pthread_rwlock_unlock(&rwlock);
    return NULL;
}
```

### 3. çº¿ç¨‹å±æ€§ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 3.1 çº¿ç¨‹åˆ†ç¦»å±æ€§ (Detached Thread)
- **åˆ†ç¦»çº¿ç¨‹**ï¼šçº¿ç¨‹ç»“æŸåè‡ªåŠ¨å›æ”¶èµ„æºï¼Œæ— éœ€`pthread_join()`
- **åˆ›å»ºæ–¹å¼**ï¼šé€šè¿‡çº¿ç¨‹å±æ€§è®¾ç½®`PTHREAD_CREATE_DETACHED`
- **æ³¨æ„äº‹é¡¹**ï¼šåˆ†ç¦»çº¿ç¨‹æ— æ³•è¢«è¿æ¥ï¼Œ`pthread_join()`ä¼šå¤±è´¥

**çº¿ç¨‹åˆ†ç¦»å±æ€§ç¤ºä¾‹**ï¼š<mcfile name="thread_detach1.c" path="/home/embedded-learning/2025-12-10/code/thread_detach1.c"></mcfile>
```c
pthread_attr_t attr;
pthread_attr_init(&attr);
// è®¾ç½®åˆ†ç¦»å±æ€§
pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
// åˆ›å»ºåˆ†ç¦»çº¿ç¨‹
pthread_create(&tid, &attr, thread_handler, NULL);
pthread_attr_destroy(&attr);

// å°è¯•joinåˆ†ç¦»çº¿ç¨‹ä¼šå¤±è´¥
ret = pthread_join(tid, NULL);
if(ret != 0){
    printf("pthread_joinåˆ†ç¦»çº¿ç¨‹å¤±è´¥ï¼ˆé”™è¯¯ç ï¼š%dï¼‰\n",ret);
}
```

#### 3.2 çº¿ç¨‹é€€å‡ºæ–¹å¼
- **æ­£å¸¸è¿”å›**ï¼š`return`è¯­å¥
- **æ˜¾å¼é€€å‡º**ï¼š`pthread_exit()`
- **å¼ºåˆ¶ç»ˆæ­¢**ï¼š`pthread_cancel()`ï¼ˆä¸æ¨èï¼‰

**çº¿ç¨‹é€€å‡ºç¤ºä¾‹**ï¼š<mcfile name="thread_exit.c" path="/home/embedded-learning/2025-12-10/code/thread_exit.c"></mcfile>
```c
// çº¿ç¨‹æ­£å¸¸é€€å‡º
return (void *)result;

// çº¿ç¨‹æ˜¾å¼é€€å‡º
pthread_exit((void *)result);
```

### 4. çº¿ç¨‹æ€§èƒ½æµ‹è¯•

#### 4.1 çº¿ç¨‹åˆ›å»ºæ€§èƒ½åŸºå‡†
- **æµ‹è¯•ç›®çš„**ï¼šå¯¹æ¯”çº¿ç¨‹åˆ›å»ºçš„å¼€é”€
- **æµ‹è¯•æ–¹æ³•**ï¼šæ‰¹é‡åˆ›å»ºçº¿ç¨‹å¹¶æµ‹é‡æ—¶é—´

**çº¿ç¨‹æ€§èƒ½æµ‹è¯•**ï¼š<mcfile name="thread_benchmark.c" path="/home/embedded-learning/2025-12-10/code/thread_benchmark.c"></mcfile>
```c
// æµ‹è¯•åˆ›å»ºNä¸ªçº¿ç¨‹çš„è€—æ—¶
clock_t start = clock();
for(int i = 0; i < THREAD_COUNT; i++) {
    pthread_create(&tids[i], NULL, empty_func, NULL);
}
// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
for(int i = 0; i < THREAD_COUNT; i++) {
    pthread_join(tids[i], NULL);
}
clock_t end = clock();
printf("åˆ›å»º%dä¸ªçº¿ç¨‹è€—æ—¶ï¼š%.2fms\n", THREAD_COUNT, (double)(end-start)*1000/CLOCKS_PER_SEC);
```

## ğŸ”§ å…³é”®çŸ¥è¯†ç‚¹

### çº¿ç¨‹IDæ‰“å°æ ¼å¼
```c
// æ­£ç¡®æ‰“å°çº¿ç¨‹IDï¼ˆä½¿ç”¨%luæ ¼å¼ç¬¦ï¼‰
printf("çº¿ç¨‹TID:%lu\n", (unsigned long)pthread_self());
printf("åˆ›å»ºçº¿ç¨‹TID:%lu\n", (unsigned long)tid);
```

### çº¿ç¨‹å®‰å…¨ç¼–ç¨‹åŸåˆ™
1. **è¯†åˆ«å…±äº«èµ„æº**ï¼šå…¨å±€å˜é‡ã€é™æ€å˜é‡ã€å †å†…å­˜
2. **ä¿æŠ¤ä¸´ç•ŒåŒº**ï¼šä½¿ç”¨äº’æ–¥é”æˆ–è¯»å†™é”
3. **é¿å…æ­»é”**ï¼šæŒ‰å›ºå®šé¡ºåºè·å–é”ï¼ŒåŠæ—¶é‡Šæ”¾é”
4. **æœ€å°åŒ–é”èŒƒå›´**ï¼šåªåœ¨å¿…è¦æ—¶æŒæœ‰é”

### çº¿ç¨‹å±æ€§ç®¡ç†
- **å±æ€§åˆå§‹åŒ–**ï¼š`pthread_attr_init()`
- **å±æ€§è®¾ç½®**ï¼š`pthread_attr_setdetachstate()`ç­‰
- **å±æ€§é”€æ¯**ï¼š`pthread_attr_destroy()`
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šå±æ€§å¯¹è±¡åœ¨çº¿ç¨‹åˆ›å»ºåå³å¯é”€æ¯

### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
```c
// æ£€æŸ¥çº¿ç¨‹å‡½æ•°è¿”å›å€¼
int ret = pthread_create(&tid, NULL, thread_func, NULL);
if(ret != 0){
    perror("pthread_create failed");
    exit(1);
}

// æ£€æŸ¥è¿æ¥æ“ä½œè¿”å›å€¼
ret = pthread_join(tid, &thread_ret);
if(ret != 0){
    perror("pthread_join failed");
    exit(1);
}
```

## ğŸ’¡ å®è·µæ€»ç»“

### çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†
- æŒæ¡äº†åŸºæœ¬çš„çº¿ç¨‹åˆ›å»ºå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- ç†è§£äº†çº¿ç¨‹è¿”å›å€¼æœºåˆ¶å’Œç±»å‹å®‰å…¨è½¬æ¢
- å­¦ä¼šäº†ä½¿ç”¨çº¿ç¨‹å±æ€§æ§åˆ¶çº¿ç¨‹è¡Œä¸º

### åŒæ­¥æœºåˆ¶åº”ç”¨
- è¯†åˆ«äº†æ•°æ®ç«äº‰é—®é¢˜çš„æ ¹æºå’Œè¡¨ç°
- æŒæ¡äº†äº’æ–¥é”å’Œè¯»å†™é”çš„ä½¿ç”¨åœºæ™¯
- ç†è§£äº†ä¸´ç•ŒåŒºä¿æŠ¤å’Œçº¿ç¨‹å®‰å…¨ç¼–ç¨‹

### æ€§èƒ½ä¼˜åŒ–æ„è¯†
- è®¤è¯†åˆ°çº¿ç¨‹åˆ›å»ºçš„å¼€é”€å’Œæ€§èƒ½å½±å“
- å­¦ä¼šäº†åŸºæœ¬çš„çº¿ç¨‹æ€§èƒ½æµ‹è¯•æ–¹æ³•
- ç†è§£äº†åˆ†ç¦»çº¿ç¨‹çš„èµ„æºç®¡ç†ä¼˜åŠ¿

## ğŸš€ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šæ•°æ®ç«äº‰å¯¼è‡´ç»“æœä¸æ­£ç¡®
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«èµ„æºè®¿é—®
```c
pthread_mutex_lock(&mutex);
// ä¸´ç•ŒåŒºæ“ä½œ
g_count++;
pthread_mutex_unlock(&mutex);
```

### é—®é¢˜2ï¼šçº¿ç¨‹èµ„æºæ³„æ¼
**è§£å†³æ–¹æ¡ˆ**ï¼šåŠæ—¶è¿æ¥æˆ–è®¾ç½®åˆ†ç¦»å±æ€§
```c
// æ–¹æ³•1ï¼šè¿æ¥çº¿ç¨‹å›æ”¶èµ„æº
pthread_join(tid, NULL);

// æ–¹æ³•2ï¼šåˆ›å»ºåˆ†ç¦»çº¿ç¨‹è‡ªåŠ¨å›æ”¶
pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
```

### é—®é¢˜3ï¼šç±»å‹è½¬æ¢å®‰å…¨
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨`long`è¿›è¡Œä¸­é—´è½¬æ¢
```c
// å®‰å…¨ç±»å‹è½¬æ¢
return (void *)(long)result;          // çº¿ç¨‹è¿”å›
long value = (long)thread_ret;        // ä¸»çº¿ç¨‹æ¥æ”¶
```

## ğŸ“ å®Œæ•´ä»£ç æ–‡ä»¶åˆ—è¡¨

- `thread_create1.c` - åŸºç¡€çº¿ç¨‹åˆ›å»ºä¸è¿”å›å€¼
- `thread_create2.c` - å¤šçº¿ç¨‹å‚æ•°ä¼ é€’
- `thread_join.c` - çº¿ç¨‹è¿æ¥ä¸è¿”å›å€¼è·å–
- `thread_detach1.c` - çº¿ç¨‹åˆ†ç¦»å±æ€§
- `thread_detach2.c` - åˆ†ç¦»çº¿ç¨‹å®è·µ
- `thread_exit.c` - çº¿ç¨‹é€€å‡ºæ–¹å¼
- `race_condition.c` - æ•°æ®ç«äº‰é—®é¢˜æ¼”ç¤º
- `mutex_dynamic.c` - åŠ¨æ€äº’æ–¥é”
- `mutex_fix.c` - é™æ€äº’æ–¥é”
- `rwlock_demo.c` - è¯»å†™é”åº”ç”¨
- `thread_benchmark.c` - çº¿ç¨‹æ€§èƒ½æµ‹è¯•

---

*å­¦ä¹ æ—¶é—´ï¼š2025å¹´12æœˆ10æ—¥*
*å­¦ä¹ é‡ç‚¹ï¼šLinuxå¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€ã€çº¿ç¨‹åŒæ­¥æœºåˆ¶ã€çº¿ç¨‹å®‰å…¨ç¼–ç¨‹*